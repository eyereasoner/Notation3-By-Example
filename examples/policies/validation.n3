@prefix pol:  <https://www.example.org/ns/policy#> .
@prefix util: <https://github.com/phochste/util#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .

# Rule validation
# .. when need a pol:Rule 
# .. with a pol:body
# .. with one and only one pol:when
# .. with at least one pol:then or pol:thenNot
(
    _Rule _Body 
    _WhenCount 
    _ThenCount 
    _ThenNotCount
    _S _O
) log:onNegativeSurface {
    _Rule a pol:Rule ;
       pol:body _Body .

    ( { _S pol:when _O } _Body) util:cardinality _WhenCount .
    ( { _S pol:then _O } _Body) util:cardinality _ThenCount .
    ( { _S pol:thenNot _O } _Body) util:cardinality _ThenNotCount .

    () log:onNegativeSurface {

        # When we have a then
        () log:onNegativeSurface {
            _WhenCount math:equalTo 1 .
            _ThenCount math:greaterThan 0 .
            () log:onNegativeSurface {
                _Rule a pol:ValidRule .
            }
        } .

        # When we have thenNot
        () log:onNegativeSurface {
            _WhenCount math:equalTo 1 .
            _ThenNotCount math:greaterThan 0 .
            () log:onNegativeSurface {
                _Rule a pol:ValidRule .
            }
        } .
    } .
} .