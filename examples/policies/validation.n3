@prefix pol:  <https://www.example.org/ns/policy#> .
@prefix util: <https://github.com/phochste/util#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .

# Rule validation
# .. when need a pol:Rule 
# .. with a pol:body
# .. with one and only one pol:when
# .. with at least one pol:then or pol:thenNot
(
    ?Rule ?Body 
    ?WhenCount 
    ?ThenCount 
    ?ThenNotCount
    ?S ?O
) log:onNegativeSurface {
    ?Rule a pol:Rule ;
       pol:body ?Body .

    ( { ?S pol:when ?O } ?Body) util:cardinality ?WhenCount .
    ( { ?S pol:then ?O } ?Body) util:cardinality ?ThenCount .
    ( { ?S pol:thenNot ?O } ?Body) util:cardinality ?ThenNotCount .

    () log:onNegativeSurface {

        # When we have a then
        () log:onNegativeSurface {
            ?WhenCount math:equalTo 1 .
            ?ThenCount math:greaterThan 0 .
            () log:onNegativeSurface {
                ?Rule a pol:ValidRule .
            }
        } .

        # When we have thenNot
        () log:onNegativeSurface {
            ?WhenCount math:equalTo 1 .
            ?ThenNotCount math:greaterThan 0 .
            () log:onNegativeSurface {
                ?Rule a pol:ValidRule .
            }
        } .
    } .
} .