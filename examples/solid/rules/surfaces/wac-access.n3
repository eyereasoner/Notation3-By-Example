@prefix : <https://example.org/ns/>.
@prefix log: <http://www.w3.org/2000/10/swap/log#>. 
@prefix acl: <http://www.w3.org/ns/auth/acl#>.

# We want to give access
# to all triples
# that are part of a resource X 
# where X has acl:allow set for the WebID in our context

(
_:Resource 
_:MetaResource 
_:ACLResource
_:ACLEntry
_:S_R _:P_R _:O_R
_:S_M _:P_M _:O_M
_:WebID
_:Scope
_:Access
_:ResourceAccess _:MetaResourceAccess
) log:onNegativeSurface {
    _:Resource a :Resource.
    _:Resource :describedby _:MetaResource.
    _:Resource :acl _:ACLResource.

    # If we are allowed by the ACL resource
    _:ACLEntry a acl:Authorization.


    (
        # if
        {
            _:ACLEntry acl:accessTo _:Resource.
            _:ACLEntry acl:mode acl:Read.
            _:ACLEntry acl:agent _:WebID.    

            # We take the agent WebID from the request context 
            :RequestContext acl:agent _:WebID.
        }
        # then
        {  
            _:Access log:equalTo {
                ()log:onResultSurface {
                    _:ResourceAccess a :AccessGrant; 
                        :forResource _:Resource;
                        :forAgent _:WebID;
                        :mode acl:read.

                    _:MetaResourceAccess a :AccessGrant;
                        :forResource _:MetaResource;
                        :forAgent _:WebID;
                        :mode acl:read.
                }
            }
        } 
        # else
        {  
            _:Access log:equalTo {
                ()log:onWarningSurface {
                    _:ResourceAccess a :AccessDenial;
                        :forResource _:Resource;
                        :forAgent _:WebID;
                        :mode acl:read;
                        :reason "No access granted in resource WAC resource." .

                    _:MetaResourceAccess a :AccessDenial;
                        :forResource _:MetaResource;
                        :forAgent _:WebID;
                        :mode acl:read;
                        :reason "No access granted in resource WAC resource." .
                }
            }
        }
    ) log:ifThenElseIn _:Scope .

    # Write out the result
    () log:onNegativeSurface _:Access .
} .